#!/usr/bin/perl
package  # Hide from PAUSE
   transalert_ctl;

# PODNAME:  transalert_ctl
# ABSTRACT: Command line daemon for Transform::Alert
# VERSION

use sanity;
use Transform::Alert;

use Log::Log4perl;
use App::Daemon 'daemonize';
use Config::General;
use Time::HiRes 'sleep';  # (for once we're needing something else besides time...)
use POSIX;
use Path::Class;

use namespace::clean;

# make sure we're starting before demanding a -c conf option
daemonize;

# steal App::Daemon's logger...
my $log = Log::Log4perl->get_logger('App::Daemon');

# ...and start using it immediately
$SIG{__DIE__} = sub {
   # We're in an eval {} and don't want log
   # this message but catch it later
   return if ($^S);

   local $Log::Log4perl::caller_depth = $Log::Log4perl::caller_depth + 1;
   $log->logdie(@_);
};

# config file loading
my $conf_file = App::Daemon::find_option('-c', 1) ||
   $log->logdie("Configuration (-c) required!");

my $conf = {
   Config::General->new(
      -ConfigFile     => $conf_file,
      -LowerCaseNames => 1,
   )->getall
};

# change the working directory to the configuration file,
# so that BaseDir can use relative paths
chdir file($conf_file)->dir->stringify;

# wait for it...
my $ta = Transform::Alert->new(
   config => $conf,
   log    => $log,
);

# (signal handling before we start)
$SIG{TERM} = sub {
   $log->logwarn("SIGTERM received... shutting down!");
   $ta->close_all;
   $log->warn("Fin.");
   exit 0;
};

# GO!
while (1) {
   my $wait = $ta->heartbeat;
   sleep $wait if ($wait > 0);
};

#### DEBUG: Pod::Usage doesn't play nice with wikidoc

__END__

=head1 SYNOPSIS

   transalert_ctl {start|stop|status}? [OPTION]...
   
   Controls the Transform::Alert daemon.
   
   Control commands:
      start      Start up the daemon.  Default action if not specified.
      stop       Stop the daemon.  Typically requires a -p option.
      status     Print out diagnostics on what the status of the daemon is.  Typically requires a -p option.
              
   Options:   
      -c FILE    Loads FILE for configuration.  Required to start the daemon.        
      -X         Foreground mode.  Log messages go to the screen.
      -l FILE    Sends Log4perl messages to FILE in background mode.  Defaults to ./transalert_ctl.log.
      -p FILE    Writes PID to FILE.  Defaults to ./transalert_ctl.pid.
      -u USER    Run as USER.  Only applies if running as root.  Defaults to 'nobody'.
      -l4p FILE  Loads FILE for Log4perl configuration.
      -v         Debug mode.  Ignored if -l4p option is specified.
 
=head1 DESCRIPTION
 
Insert description here...

=head1 CAVEATS

Bad stuff...

=head1 SEE ALSO

Other modules...

=head1 ACKNOWLEDGEMENTS

Thanks and stuff...
